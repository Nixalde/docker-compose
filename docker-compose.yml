version: '3'

services:

### Balanceador de carga ( HAproxy )

  loadbalancer:
    image: debian/haproxy
    container_name: balancer
    hostname: balancer
    network_mode: host
    volumes:
      - /etc/haproxy
    depends_on:
      - db
      - memcache
      - php
      - nginx
      - varnish
      - templater
      
  templater:
    image: templater
    container_name: templater
    hostname: templater
    network_mode: host
    volumes:
      - ./haproxy.ctmpl:/tmp/haproxy.ctmpl:ro
      - /var/run/docker.sock:/var/run/docker.sock
    volumes_from:
      - loadbalancer
    command: consul-template -template "/tmp/haproxy.ctmpl:/etc/haproxy/haproxy.cfg:docker restart balancer"
    depends_on:
       - db
       - memcache
       - php
       - nginx
       - varnish
    

###

### Proxy Inverso ( Varnish)

  varnish:
    image: secoresearch/varnish
    env_file:
      - ".env"
    ports:
      - 80:80
    depends_on:
      - db
      - memcache
      - php
      - nginx

###

### Servidor web ( Nginx )

  nginx:
    image: nginx
    volumes:
    - ./servidor_web/conf/site.conf:/etc/nginx/conf.d/site.conf
    - ./servidor_web/conf/nginx.conf:/etc/nginx/nginx.conf
    ports:
      - 8080:8080
    env_file:
      - ".env"
    command: /bin/bash -c "envsubst &lt; /etc/nginx/conf.d/site.conf &gt; /etc/nginx/conf.d/default.conf &amp;&amp; exec nginx -g 'daemon off;'"
    depends_on:
      - db
      - memcache
      - php

###

### Servidor PHP ( joomla )

  php:
    build:
        contest: ./servidor_aplicaciones
    ports:
      - 9000:9000
    volumes:
      - ./servidor_apliaciones/conf/www.conf:/usr/local/etc/php-fpm.d/www.conf
    env_file:
      - ".env"
    depends_on:
      - db
      - memcache

###

### Servido Cache de base de datos ( MemCache )
  memcache:
     image: memcache
     ports:
     - 11211:11211
     env_file:
       - ".env"
     depends_on:
       - db
###

### Servidor de Base de datos ( MariaDB )

  db:
    image: mariadb
    env_file:
      - ".env"
    ports:
      - 3306:3306

###
